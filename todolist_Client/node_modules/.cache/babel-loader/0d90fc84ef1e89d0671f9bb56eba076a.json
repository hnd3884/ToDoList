{"ast":null,"code":"'use strict';\n\nconst Query = require('../connection/commands').Query;\n\nconst MongoError = require('../error').MongoError;\n\nconst getReadPreference = require('./shared').getReadPreference;\n\nconst collectionNamespace = require('./shared').collectionNamespace;\n\nconst isSharded = require('./shared').isSharded;\n\nconst maxWireVersion = require('../utils').maxWireVersion;\n\nconst applyCommonQueryOptions = require('./shared').applyCommonQueryOptions;\n\nconst command = require('./command');\n\nfunction query(server, ns, cmd, cursorState, options, callback) {\n  options = options || {};\n\n  if (cursorState.cursorId != null) {\n    return callback();\n  }\n\n  if (cmd == null) {\n    return callback(new MongoError(`command ${JSON.stringify(cmd)} does not return a cursor`));\n  }\n\n  if (maxWireVersion(server) < 4) {\n    const query = prepareLegacyFindQuery(server, ns, cmd, cursorState, options);\n    const queryOptions = applyCommonQueryOptions({}, cursorState);\n\n    if (typeof query.documentsReturnedIn === 'string') {\n      queryOptions.documentsReturnedIn = query.documentsReturnedIn;\n    }\n\n    server.s.pool.write(query, queryOptions, callback);\n    return;\n  }\n\n  const readPreference = getReadPreference(cmd, options);\n  const findCmd = prepareFindCommand(server, ns, cmd, cursorState, options); // NOTE: This actually modifies the passed in cmd, and our code _depends_ on this\n  //       side-effect. Change this ASAP\n\n  cmd.virtual = false;\n  const commandOptions = Object.assign({\n    documentsReturnedIn: 'firstBatch',\n    numberToReturn: 1,\n    slaveOk: readPreference.slaveOk()\n  }, options);\n\n  if (cmd.readPreference) {\n    commandOptions.readPreference = readPreference;\n  }\n\n  if (cursorState.session) {\n    commandOptions.session = cursorState.session;\n  }\n\n  command(server, ns, findCmd, commandOptions, callback);\n}\n\nfunction prepareFindCommand(server, ns, cmd, cursorState) {\n  cursorState.batchSize = cmd.batchSize || cursorState.batchSize;\n  let findCmd = {\n    find: collectionNamespace(ns)\n  };\n\n  if (cmd.query) {\n    if (cmd.query['$query']) {\n      findCmd.filter = cmd.query['$query'];\n    } else {\n      findCmd.filter = cmd.query;\n    }\n  }\n\n  let sortValue = cmd.sort;\n\n  if (Array.isArray(sortValue)) {\n    const sortObject = {};\n\n    if (sortValue.length > 0 && !Array.isArray(sortValue[0])) {\n      let sortDirection = sortValue[1];\n\n      if (sortDirection === 'asc') {\n        sortDirection = 1;\n      } else if (sortDirection === 'desc') {\n        sortDirection = -1;\n      }\n\n      sortObject[sortValue[0]] = sortDirection;\n    } else {\n      for (let i = 0; i < sortValue.length; i++) {\n        let sortDirection = sortValue[i][1];\n\n        if (sortDirection === 'asc') {\n          sortDirection = 1;\n        } else if (sortDirection === 'desc') {\n          sortDirection = -1;\n        }\n\n        sortObject[sortValue[i][0]] = sortDirection;\n      }\n    }\n\n    sortValue = sortObject;\n  }\n\n  if (cmd.sort) findCmd.sort = sortValue;\n  if (cmd.fields) findCmd.projection = cmd.fields;\n  if (cmd.hint) findCmd.hint = cmd.hint;\n  if (cmd.skip) findCmd.skip = cmd.skip;\n  if (cmd.limit) findCmd.limit = cmd.limit;\n\n  if (cmd.limit < 0) {\n    findCmd.limit = Math.abs(cmd.limit);\n    findCmd.singleBatch = true;\n  }\n\n  if (typeof cmd.batchSize === 'number') {\n    if (cmd.batchSize < 0) {\n      if (cmd.limit !== 0 && Math.abs(cmd.batchSize) < Math.abs(cmd.limit)) {\n        findCmd.limit = Math.abs(cmd.batchSize);\n      }\n\n      findCmd.singleBatch = true;\n    }\n\n    findCmd.batchSize = Math.abs(cmd.batchSize);\n  }\n\n  if (cmd.comment) findCmd.comment = cmd.comment;\n  if (cmd.maxScan) findCmd.maxScan = cmd.maxScan;\n  if (cmd.maxTimeMS) findCmd.maxTimeMS = cmd.maxTimeMS;\n  if (cmd.min) findCmd.min = cmd.min;\n  if (cmd.max) findCmd.max = cmd.max;\n  findCmd.returnKey = cmd.returnKey ? cmd.returnKey : false;\n  findCmd.showRecordId = cmd.showDiskLoc ? cmd.showDiskLoc : false;\n  if (cmd.snapshot) findCmd.snapshot = cmd.snapshot;\n  if (cmd.tailable) findCmd.tailable = cmd.tailable;\n  if (cmd.oplogReplay) findCmd.oplogReplay = cmd.oplogReplay;\n  if (cmd.noCursorTimeout) findCmd.noCursorTimeout = cmd.noCursorTimeout;\n  if (cmd.awaitData) findCmd.awaitData = cmd.awaitData;\n  if (cmd.awaitdata) findCmd.awaitData = cmd.awaitdata;\n  if (cmd.partial) findCmd.partial = cmd.partial;\n  if (cmd.collation) findCmd.collation = cmd.collation;\n  if (cmd.readConcern) findCmd.readConcern = cmd.readConcern; // If we have explain, we need to rewrite the find command\n  // to wrap it in the explain command\n\n  if (cmd.explain) {\n    findCmd = {\n      explain: findCmd\n    };\n  }\n\n  return findCmd;\n}\n\nfunction prepareLegacyFindQuery(server, ns, cmd, cursorState, options) {\n  options = options || {};\n  const bson = server.s.bson;\n  const readPreference = getReadPreference(cmd, options);\n  cursorState.batchSize = cmd.batchSize || cursorState.batchSize;\n  let numberToReturn = 0;\n\n  if (cursorState.limit < 0 || cursorState.limit !== 0 && cursorState.limit < cursorState.batchSize || cursorState.limit > 0 && cursorState.batchSize === 0) {\n    numberToReturn = cursorState.limit;\n  } else {\n    numberToReturn = cursorState.batchSize;\n  }\n\n  const numberToSkip = cursorState.skip || 0;\n  const findCmd = {};\n\n  if (isSharded(server) && readPreference) {\n    findCmd['$readPreference'] = readPreference.toJSON();\n  }\n\n  if (cmd.sort) findCmd['$orderby'] = cmd.sort;\n  if (cmd.hint) findCmd['$hint'] = cmd.hint;\n  if (cmd.snapshot) findCmd['$snapshot'] = cmd.snapshot;\n  if (typeof cmd.returnKey !== 'undefined') findCmd['$returnKey'] = cmd.returnKey;\n  if (cmd.maxScan) findCmd['$maxScan'] = cmd.maxScan;\n  if (cmd.min) findCmd['$min'] = cmd.min;\n  if (cmd.max) findCmd['$max'] = cmd.max;\n  if (typeof cmd.showDiskLoc !== 'undefined') findCmd['$showDiskLoc'] = cmd.showDiskLoc;\n  if (cmd.comment) findCmd['$comment'] = cmd.comment;\n  if (cmd.maxTimeMS) findCmd['$maxTimeMS'] = cmd.maxTimeMS;\n\n  if (cmd.explain) {\n    // nToReturn must be 0 (match all) or negative (match N and close cursor)\n    // nToReturn > 0 will give explain results equivalent to limit(0)\n    numberToReturn = -Math.abs(cmd.limit || 0);\n    findCmd['$explain'] = true;\n  }\n\n  findCmd['$query'] = cmd.query;\n\n  if (cmd.readConcern && cmd.readConcern.level !== 'local') {\n    throw new MongoError(`server find command does not support a readConcern level of ${cmd.readConcern.level}`);\n  }\n\n  if (cmd.readConcern) {\n    cmd = Object.assign({}, cmd);\n    delete cmd['readConcern'];\n  }\n\n  const serializeFunctions = typeof options.serializeFunctions === 'boolean' ? options.serializeFunctions : false;\n  const ignoreUndefined = typeof options.ignoreUndefined === 'boolean' ? options.ignoreUndefined : false;\n  const query = new Query(bson, ns, findCmd, {\n    numberToSkip: numberToSkip,\n    numberToReturn: numberToReturn,\n    pre32Limit: typeof cmd.limit !== 'undefined' ? cmd.limit : undefined,\n    checkKeys: false,\n    returnFieldSelector: cmd.fields,\n    serializeFunctions: serializeFunctions,\n    ignoreUndefined: ignoreUndefined\n  });\n  if (typeof cmd.tailable === 'boolean') query.tailable = cmd.tailable;\n  if (typeof cmd.oplogReplay === 'boolean') query.oplogReplay = cmd.oplogReplay;\n  if (typeof cmd.noCursorTimeout === 'boolean') query.noCursorTimeout = cmd.noCursorTimeout;\n  if (typeof cmd.awaitData === 'boolean') query.awaitData = cmd.awaitData;\n  if (typeof cmd.partial === 'boolean') query.partial = cmd.partial;\n  query.slaveOk = readPreference.slaveOk();\n  return query;\n}\n\nmodule.exports = query;","map":{"version":3,"sources":["/home/hoangnd/source/ReactJS/todolist/node_modules/mongodb/lib/core/wireprotocol/query.js"],"names":["Query","require","MongoError","getReadPreference","collectionNamespace","isSharded","maxWireVersion","applyCommonQueryOptions","command","query","server","ns","cmd","cursorState","options","callback","cursorId","JSON","stringify","prepareLegacyFindQuery","queryOptions","documentsReturnedIn","s","pool","write","readPreference","findCmd","prepareFindCommand","virtual","commandOptions","Object","assign","numberToReturn","slaveOk","session","batchSize","find","filter","sortValue","sort","Array","isArray","sortObject","length","sortDirection","i","fields","projection","hint","skip","limit","Math","abs","singleBatch","comment","maxScan","maxTimeMS","min","max","returnKey","showRecordId","showDiskLoc","snapshot","tailable","oplogReplay","noCursorTimeout","awaitData","awaitdata","partial","collation","readConcern","explain","bson","numberToSkip","toJSON","level","serializeFunctions","ignoreUndefined","pre32Limit","undefined","checkKeys","returnFieldSelector","module","exports"],"mappings":"AAAA;;AAEA,MAAMA,KAAK,GAAGC,OAAO,CAAC,wBAAD,CAAP,CAAkCD,KAAhD;;AACA,MAAME,UAAU,GAAGD,OAAO,CAAC,UAAD,CAAP,CAAoBC,UAAvC;;AACA,MAAMC,iBAAiB,GAAGF,OAAO,CAAC,UAAD,CAAP,CAAoBE,iBAA9C;;AACA,MAAMC,mBAAmB,GAAGH,OAAO,CAAC,UAAD,CAAP,CAAoBG,mBAAhD;;AACA,MAAMC,SAAS,GAAGJ,OAAO,CAAC,UAAD,CAAP,CAAoBI,SAAtC;;AACA,MAAMC,cAAc,GAAGL,OAAO,CAAC,UAAD,CAAP,CAAoBK,cAA3C;;AACA,MAAMC,uBAAuB,GAAGN,OAAO,CAAC,UAAD,CAAP,CAAoBM,uBAApD;;AACA,MAAMC,OAAO,GAAGP,OAAO,CAAC,WAAD,CAAvB;;AAEA,SAASQ,KAAT,CAAeC,MAAf,EAAuBC,EAAvB,EAA2BC,GAA3B,EAAgCC,WAAhC,EAA6CC,OAA7C,EAAsDC,QAAtD,EAAgE;AAC9DD,EAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;;AACA,MAAID,WAAW,CAACG,QAAZ,IAAwB,IAA5B,EAAkC;AAChC,WAAOD,QAAQ,EAAf;AACD;;AAED,MAAIH,GAAG,IAAI,IAAX,EAAiB;AACf,WAAOG,QAAQ,CAAC,IAAIb,UAAJ,CAAgB,WAAUe,IAAI,CAACC,SAAL,CAAeN,GAAf,CAAoB,2BAA9C,CAAD,CAAf;AACD;;AAED,MAAIN,cAAc,CAACI,MAAD,CAAd,GAAyB,CAA7B,EAAgC;AAC9B,UAAMD,KAAK,GAAGU,sBAAsB,CAACT,MAAD,EAASC,EAAT,EAAaC,GAAb,EAAkBC,WAAlB,EAA+BC,OAA/B,CAApC;AACA,UAAMM,YAAY,GAAGb,uBAAuB,CAAC,EAAD,EAAKM,WAAL,CAA5C;;AACA,QAAI,OAAOJ,KAAK,CAACY,mBAAb,KAAqC,QAAzC,EAAmD;AACjDD,MAAAA,YAAY,CAACC,mBAAb,GAAmCZ,KAAK,CAACY,mBAAzC;AACD;;AAEDX,IAAAA,MAAM,CAACY,CAAP,CAASC,IAAT,CAAcC,KAAd,CAAoBf,KAApB,EAA2BW,YAA3B,EAAyCL,QAAzC;AACA;AACD;;AAED,QAAMU,cAAc,GAAGtB,iBAAiB,CAACS,GAAD,EAAME,OAAN,CAAxC;AACA,QAAMY,OAAO,GAAGC,kBAAkB,CAACjB,MAAD,EAASC,EAAT,EAAaC,GAAb,EAAkBC,WAAlB,EAA+BC,OAA/B,CAAlC,CAtB8D,CAwB9D;AACA;;AACAF,EAAAA,GAAG,CAACgB,OAAJ,GAAc,KAAd;AAEA,QAAMC,cAAc,GAAGC,MAAM,CAACC,MAAP,CACrB;AACEV,IAAAA,mBAAmB,EAAE,YADvB;AAEEW,IAAAA,cAAc,EAAE,CAFlB;AAGEC,IAAAA,OAAO,EAAER,cAAc,CAACQ,OAAf;AAHX,GADqB,EAMrBnB,OANqB,CAAvB;;AASA,MAAIF,GAAG,CAACa,cAAR,EAAwB;AACtBI,IAAAA,cAAc,CAACJ,cAAf,GAAgCA,cAAhC;AACD;;AAED,MAAIZ,WAAW,CAACqB,OAAhB,EAAyB;AACvBL,IAAAA,cAAc,CAACK,OAAf,GAAyBrB,WAAW,CAACqB,OAArC;AACD;;AAED1B,EAAAA,OAAO,CAACE,MAAD,EAASC,EAAT,EAAae,OAAb,EAAsBG,cAAtB,EAAsCd,QAAtC,CAAP;AACD;;AAED,SAASY,kBAAT,CAA4BjB,MAA5B,EAAoCC,EAApC,EAAwCC,GAAxC,EAA6CC,WAA7C,EAA0D;AACxDA,EAAAA,WAAW,CAACsB,SAAZ,GAAwBvB,GAAG,CAACuB,SAAJ,IAAiBtB,WAAW,CAACsB,SAArD;AACA,MAAIT,OAAO,GAAG;AACZU,IAAAA,IAAI,EAAEhC,mBAAmB,CAACO,EAAD;AADb,GAAd;;AAIA,MAAIC,GAAG,CAACH,KAAR,EAAe;AACb,QAAIG,GAAG,CAACH,KAAJ,CAAU,QAAV,CAAJ,EAAyB;AACvBiB,MAAAA,OAAO,CAACW,MAAR,GAAiBzB,GAAG,CAACH,KAAJ,CAAU,QAAV,CAAjB;AACD,KAFD,MAEO;AACLiB,MAAAA,OAAO,CAACW,MAAR,GAAiBzB,GAAG,CAACH,KAArB;AACD;AACF;;AAED,MAAI6B,SAAS,GAAG1B,GAAG,CAAC2B,IAApB;;AACA,MAAIC,KAAK,CAACC,OAAN,CAAcH,SAAd,CAAJ,EAA8B;AAC5B,UAAMI,UAAU,GAAG,EAAnB;;AAEA,QAAIJ,SAAS,CAACK,MAAV,GAAmB,CAAnB,IAAwB,CAACH,KAAK,CAACC,OAAN,CAAcH,SAAS,CAAC,CAAD,CAAvB,CAA7B,EAA0D;AACxD,UAAIM,aAAa,GAAGN,SAAS,CAAC,CAAD,CAA7B;;AACA,UAAIM,aAAa,KAAK,KAAtB,EAA6B;AAC3BA,QAAAA,aAAa,GAAG,CAAhB;AACD,OAFD,MAEO,IAAIA,aAAa,KAAK,MAAtB,EAA8B;AACnCA,QAAAA,aAAa,GAAG,CAAC,CAAjB;AACD;;AAEDF,MAAAA,UAAU,CAACJ,SAAS,CAAC,CAAD,CAAV,CAAV,GAA2BM,aAA3B;AACD,KATD,MASO;AACL,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGP,SAAS,CAACK,MAA9B,EAAsCE,CAAC,EAAvC,EAA2C;AACzC,YAAID,aAAa,GAAGN,SAAS,CAACO,CAAD,CAAT,CAAa,CAAb,CAApB;;AACA,YAAID,aAAa,KAAK,KAAtB,EAA6B;AAC3BA,UAAAA,aAAa,GAAG,CAAhB;AACD,SAFD,MAEO,IAAIA,aAAa,KAAK,MAAtB,EAA8B;AACnCA,UAAAA,aAAa,GAAG,CAAC,CAAjB;AACD;;AAEDF,QAAAA,UAAU,CAACJ,SAAS,CAACO,CAAD,CAAT,CAAa,CAAb,CAAD,CAAV,GAA8BD,aAA9B;AACD;AACF;;AAEDN,IAAAA,SAAS,GAAGI,UAAZ;AACD;;AAED,MAAI9B,GAAG,CAAC2B,IAAR,EAAcb,OAAO,CAACa,IAAR,GAAeD,SAAf;AACd,MAAI1B,GAAG,CAACkC,MAAR,EAAgBpB,OAAO,CAACqB,UAAR,GAAqBnC,GAAG,CAACkC,MAAzB;AAChB,MAAIlC,GAAG,CAACoC,IAAR,EAActB,OAAO,CAACsB,IAAR,GAAepC,GAAG,CAACoC,IAAnB;AACd,MAAIpC,GAAG,CAACqC,IAAR,EAAcvB,OAAO,CAACuB,IAAR,GAAerC,GAAG,CAACqC,IAAnB;AACd,MAAIrC,GAAG,CAACsC,KAAR,EAAexB,OAAO,CAACwB,KAAR,GAAgBtC,GAAG,CAACsC,KAApB;;AACf,MAAItC,GAAG,CAACsC,KAAJ,GAAY,CAAhB,EAAmB;AACjBxB,IAAAA,OAAO,CAACwB,KAAR,GAAgBC,IAAI,CAACC,GAAL,CAASxC,GAAG,CAACsC,KAAb,CAAhB;AACAxB,IAAAA,OAAO,CAAC2B,WAAR,GAAsB,IAAtB;AACD;;AAED,MAAI,OAAOzC,GAAG,CAACuB,SAAX,KAAyB,QAA7B,EAAuC;AACrC,QAAIvB,GAAG,CAACuB,SAAJ,GAAgB,CAApB,EAAuB;AACrB,UAAIvB,GAAG,CAACsC,KAAJ,KAAc,CAAd,IAAmBC,IAAI,CAACC,GAAL,CAASxC,GAAG,CAACuB,SAAb,IAA0BgB,IAAI,CAACC,GAAL,CAASxC,GAAG,CAACsC,KAAb,CAAjD,EAAsE;AACpExB,QAAAA,OAAO,CAACwB,KAAR,GAAgBC,IAAI,CAACC,GAAL,CAASxC,GAAG,CAACuB,SAAb,CAAhB;AACD;;AAEDT,MAAAA,OAAO,CAAC2B,WAAR,GAAsB,IAAtB;AACD;;AAED3B,IAAAA,OAAO,CAACS,SAAR,GAAoBgB,IAAI,CAACC,GAAL,CAASxC,GAAG,CAACuB,SAAb,CAApB;AACD;;AAED,MAAIvB,GAAG,CAAC0C,OAAR,EAAiB5B,OAAO,CAAC4B,OAAR,GAAkB1C,GAAG,CAAC0C,OAAtB;AACjB,MAAI1C,GAAG,CAAC2C,OAAR,EAAiB7B,OAAO,CAAC6B,OAAR,GAAkB3C,GAAG,CAAC2C,OAAtB;AACjB,MAAI3C,GAAG,CAAC4C,SAAR,EAAmB9B,OAAO,CAAC8B,SAAR,GAAoB5C,GAAG,CAAC4C,SAAxB;AACnB,MAAI5C,GAAG,CAAC6C,GAAR,EAAa/B,OAAO,CAAC+B,GAAR,GAAc7C,GAAG,CAAC6C,GAAlB;AACb,MAAI7C,GAAG,CAAC8C,GAAR,EAAahC,OAAO,CAACgC,GAAR,GAAc9C,GAAG,CAAC8C,GAAlB;AACbhC,EAAAA,OAAO,CAACiC,SAAR,GAAoB/C,GAAG,CAAC+C,SAAJ,GAAgB/C,GAAG,CAAC+C,SAApB,GAAgC,KAApD;AACAjC,EAAAA,OAAO,CAACkC,YAAR,GAAuBhD,GAAG,CAACiD,WAAJ,GAAkBjD,GAAG,CAACiD,WAAtB,GAAoC,KAA3D;AACA,MAAIjD,GAAG,CAACkD,QAAR,EAAkBpC,OAAO,CAACoC,QAAR,GAAmBlD,GAAG,CAACkD,QAAvB;AAClB,MAAIlD,GAAG,CAACmD,QAAR,EAAkBrC,OAAO,CAACqC,QAAR,GAAmBnD,GAAG,CAACmD,QAAvB;AAClB,MAAInD,GAAG,CAACoD,WAAR,EAAqBtC,OAAO,CAACsC,WAAR,GAAsBpD,GAAG,CAACoD,WAA1B;AACrB,MAAIpD,GAAG,CAACqD,eAAR,EAAyBvC,OAAO,CAACuC,eAAR,GAA0BrD,GAAG,CAACqD,eAA9B;AACzB,MAAIrD,GAAG,CAACsD,SAAR,EAAmBxC,OAAO,CAACwC,SAAR,GAAoBtD,GAAG,CAACsD,SAAxB;AACnB,MAAItD,GAAG,CAACuD,SAAR,EAAmBzC,OAAO,CAACwC,SAAR,GAAoBtD,GAAG,CAACuD,SAAxB;AACnB,MAAIvD,GAAG,CAACwD,OAAR,EAAiB1C,OAAO,CAAC0C,OAAR,GAAkBxD,GAAG,CAACwD,OAAtB;AACjB,MAAIxD,GAAG,CAACyD,SAAR,EAAmB3C,OAAO,CAAC2C,SAAR,GAAoBzD,GAAG,CAACyD,SAAxB;AACnB,MAAIzD,GAAG,CAAC0D,WAAR,EAAqB5C,OAAO,CAAC4C,WAAR,GAAsB1D,GAAG,CAAC0D,WAA1B,CAhFmC,CAkFxD;AACA;;AACA,MAAI1D,GAAG,CAAC2D,OAAR,EAAiB;AACf7C,IAAAA,OAAO,GAAG;AACR6C,MAAAA,OAAO,EAAE7C;AADD,KAAV;AAGD;;AAED,SAAOA,OAAP;AACD;;AAED,SAASP,sBAAT,CAAgCT,MAAhC,EAAwCC,EAAxC,EAA4CC,GAA5C,EAAiDC,WAAjD,EAA8DC,OAA9D,EAAuE;AACrEA,EAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AACA,QAAM0D,IAAI,GAAG9D,MAAM,CAACY,CAAP,CAASkD,IAAtB;AACA,QAAM/C,cAAc,GAAGtB,iBAAiB,CAACS,GAAD,EAAME,OAAN,CAAxC;AACAD,EAAAA,WAAW,CAACsB,SAAZ,GAAwBvB,GAAG,CAACuB,SAAJ,IAAiBtB,WAAW,CAACsB,SAArD;AAEA,MAAIH,cAAc,GAAG,CAArB;;AACA,MACEnB,WAAW,CAACqC,KAAZ,GAAoB,CAApB,IACCrC,WAAW,CAACqC,KAAZ,KAAsB,CAAtB,IAA2BrC,WAAW,CAACqC,KAAZ,GAAoBrC,WAAW,CAACsB,SAD5D,IAECtB,WAAW,CAACqC,KAAZ,GAAoB,CAApB,IAAyBrC,WAAW,CAACsB,SAAZ,KAA0B,CAHtD,EAIE;AACAH,IAAAA,cAAc,GAAGnB,WAAW,CAACqC,KAA7B;AACD,GAND,MAMO;AACLlB,IAAAA,cAAc,GAAGnB,WAAW,CAACsB,SAA7B;AACD;;AAED,QAAMsC,YAAY,GAAG5D,WAAW,CAACoC,IAAZ,IAAoB,CAAzC;AAEA,QAAMvB,OAAO,GAAG,EAAhB;;AACA,MAAIrB,SAAS,CAACK,MAAD,CAAT,IAAqBe,cAAzB,EAAyC;AACvCC,IAAAA,OAAO,CAAC,iBAAD,CAAP,GAA6BD,cAAc,CAACiD,MAAf,EAA7B;AACD;;AAED,MAAI9D,GAAG,CAAC2B,IAAR,EAAcb,OAAO,CAAC,UAAD,CAAP,GAAsBd,GAAG,CAAC2B,IAA1B;AACd,MAAI3B,GAAG,CAACoC,IAAR,EAActB,OAAO,CAAC,OAAD,CAAP,GAAmBd,GAAG,CAACoC,IAAvB;AACd,MAAIpC,GAAG,CAACkD,QAAR,EAAkBpC,OAAO,CAAC,WAAD,CAAP,GAAuBd,GAAG,CAACkD,QAA3B;AAClB,MAAI,OAAOlD,GAAG,CAAC+C,SAAX,KAAyB,WAA7B,EAA0CjC,OAAO,CAAC,YAAD,CAAP,GAAwBd,GAAG,CAAC+C,SAA5B;AAC1C,MAAI/C,GAAG,CAAC2C,OAAR,EAAiB7B,OAAO,CAAC,UAAD,CAAP,GAAsBd,GAAG,CAAC2C,OAA1B;AACjB,MAAI3C,GAAG,CAAC6C,GAAR,EAAa/B,OAAO,CAAC,MAAD,CAAP,GAAkBd,GAAG,CAAC6C,GAAtB;AACb,MAAI7C,GAAG,CAAC8C,GAAR,EAAahC,OAAO,CAAC,MAAD,CAAP,GAAkBd,GAAG,CAAC8C,GAAtB;AACb,MAAI,OAAO9C,GAAG,CAACiD,WAAX,KAA2B,WAA/B,EAA4CnC,OAAO,CAAC,cAAD,CAAP,GAA0Bd,GAAG,CAACiD,WAA9B;AAC5C,MAAIjD,GAAG,CAAC0C,OAAR,EAAiB5B,OAAO,CAAC,UAAD,CAAP,GAAsBd,GAAG,CAAC0C,OAA1B;AACjB,MAAI1C,GAAG,CAAC4C,SAAR,EAAmB9B,OAAO,CAAC,YAAD,CAAP,GAAwBd,GAAG,CAAC4C,SAA5B;;AACnB,MAAI5C,GAAG,CAAC2D,OAAR,EAAiB;AACf;AACA;AACAvC,IAAAA,cAAc,GAAG,CAACmB,IAAI,CAACC,GAAL,CAASxC,GAAG,CAACsC,KAAJ,IAAa,CAAtB,CAAlB;AACAxB,IAAAA,OAAO,CAAC,UAAD,CAAP,GAAsB,IAAtB;AACD;;AAEDA,EAAAA,OAAO,CAAC,QAAD,CAAP,GAAoBd,GAAG,CAACH,KAAxB;;AACA,MAAIG,GAAG,CAAC0D,WAAJ,IAAmB1D,GAAG,CAAC0D,WAAJ,CAAgBK,KAAhB,KAA0B,OAAjD,EAA0D;AACxD,UAAM,IAAIzE,UAAJ,CACH,+DAA8DU,GAAG,CAAC0D,WAAJ,CAAgBK,KAAM,EADjF,CAAN;AAGD;;AAED,MAAI/D,GAAG,CAAC0D,WAAR,EAAqB;AACnB1D,IAAAA,GAAG,GAAGkB,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBnB,GAAlB,CAAN;AACA,WAAOA,GAAG,CAAC,aAAD,CAAV;AACD;;AAED,QAAMgE,kBAAkB,GACtB,OAAO9D,OAAO,CAAC8D,kBAAf,KAAsC,SAAtC,GAAkD9D,OAAO,CAAC8D,kBAA1D,GAA+E,KADjF;AAEA,QAAMC,eAAe,GACnB,OAAO/D,OAAO,CAAC+D,eAAf,KAAmC,SAAnC,GAA+C/D,OAAO,CAAC+D,eAAvD,GAAyE,KAD3E;AAGA,QAAMpE,KAAK,GAAG,IAAIT,KAAJ,CAAUwE,IAAV,EAAgB7D,EAAhB,EAAoBe,OAApB,EAA6B;AACzC+C,IAAAA,YAAY,EAAEA,YAD2B;AAEzCzC,IAAAA,cAAc,EAAEA,cAFyB;AAGzC8C,IAAAA,UAAU,EAAE,OAAOlE,GAAG,CAACsC,KAAX,KAAqB,WAArB,GAAmCtC,GAAG,CAACsC,KAAvC,GAA+C6B,SAHlB;AAIzCC,IAAAA,SAAS,EAAE,KAJ8B;AAKzCC,IAAAA,mBAAmB,EAAErE,GAAG,CAACkC,MALgB;AAMzC8B,IAAAA,kBAAkB,EAAEA,kBANqB;AAOzCC,IAAAA,eAAe,EAAEA;AAPwB,GAA7B,CAAd;AAUA,MAAI,OAAOjE,GAAG,CAACmD,QAAX,KAAwB,SAA5B,EAAuCtD,KAAK,CAACsD,QAAN,GAAiBnD,GAAG,CAACmD,QAArB;AACvC,MAAI,OAAOnD,GAAG,CAACoD,WAAX,KAA2B,SAA/B,EAA0CvD,KAAK,CAACuD,WAAN,GAAoBpD,GAAG,CAACoD,WAAxB;AAC1C,MAAI,OAAOpD,GAAG,CAACqD,eAAX,KAA+B,SAAnC,EAA8CxD,KAAK,CAACwD,eAAN,GAAwBrD,GAAG,CAACqD,eAA5B;AAC9C,MAAI,OAAOrD,GAAG,CAACsD,SAAX,KAAyB,SAA7B,EAAwCzD,KAAK,CAACyD,SAAN,GAAkBtD,GAAG,CAACsD,SAAtB;AACxC,MAAI,OAAOtD,GAAG,CAACwD,OAAX,KAAuB,SAA3B,EAAsC3D,KAAK,CAAC2D,OAAN,GAAgBxD,GAAG,CAACwD,OAApB;AAEtC3D,EAAAA,KAAK,CAACwB,OAAN,GAAgBR,cAAc,CAACQ,OAAf,EAAhB;AACA,SAAOxB,KAAP;AACD;;AAEDyE,MAAM,CAACC,OAAP,GAAiB1E,KAAjB","sourcesContent":["'use strict';\n\nconst Query = require('../connection/commands').Query;\nconst MongoError = require('../error').MongoError;\nconst getReadPreference = require('./shared').getReadPreference;\nconst collectionNamespace = require('./shared').collectionNamespace;\nconst isSharded = require('./shared').isSharded;\nconst maxWireVersion = require('../utils').maxWireVersion;\nconst applyCommonQueryOptions = require('./shared').applyCommonQueryOptions;\nconst command = require('./command');\n\nfunction query(server, ns, cmd, cursorState, options, callback) {\n  options = options || {};\n  if (cursorState.cursorId != null) {\n    return callback();\n  }\n\n  if (cmd == null) {\n    return callback(new MongoError(`command ${JSON.stringify(cmd)} does not return a cursor`));\n  }\n\n  if (maxWireVersion(server) < 4) {\n    const query = prepareLegacyFindQuery(server, ns, cmd, cursorState, options);\n    const queryOptions = applyCommonQueryOptions({}, cursorState);\n    if (typeof query.documentsReturnedIn === 'string') {\n      queryOptions.documentsReturnedIn = query.documentsReturnedIn;\n    }\n\n    server.s.pool.write(query, queryOptions, callback);\n    return;\n  }\n\n  const readPreference = getReadPreference(cmd, options);\n  const findCmd = prepareFindCommand(server, ns, cmd, cursorState, options);\n\n  // NOTE: This actually modifies the passed in cmd, and our code _depends_ on this\n  //       side-effect. Change this ASAP\n  cmd.virtual = false;\n\n  const commandOptions = Object.assign(\n    {\n      documentsReturnedIn: 'firstBatch',\n      numberToReturn: 1,\n      slaveOk: readPreference.slaveOk()\n    },\n    options\n  );\n\n  if (cmd.readPreference) {\n    commandOptions.readPreference = readPreference;\n  }\n\n  if (cursorState.session) {\n    commandOptions.session = cursorState.session;\n  }\n\n  command(server, ns, findCmd, commandOptions, callback);\n}\n\nfunction prepareFindCommand(server, ns, cmd, cursorState) {\n  cursorState.batchSize = cmd.batchSize || cursorState.batchSize;\n  let findCmd = {\n    find: collectionNamespace(ns)\n  };\n\n  if (cmd.query) {\n    if (cmd.query['$query']) {\n      findCmd.filter = cmd.query['$query'];\n    } else {\n      findCmd.filter = cmd.query;\n    }\n  }\n\n  let sortValue = cmd.sort;\n  if (Array.isArray(sortValue)) {\n    const sortObject = {};\n\n    if (sortValue.length > 0 && !Array.isArray(sortValue[0])) {\n      let sortDirection = sortValue[1];\n      if (sortDirection === 'asc') {\n        sortDirection = 1;\n      } else if (sortDirection === 'desc') {\n        sortDirection = -1;\n      }\n\n      sortObject[sortValue[0]] = sortDirection;\n    } else {\n      for (let i = 0; i < sortValue.length; i++) {\n        let sortDirection = sortValue[i][1];\n        if (sortDirection === 'asc') {\n          sortDirection = 1;\n        } else if (sortDirection === 'desc') {\n          sortDirection = -1;\n        }\n\n        sortObject[sortValue[i][0]] = sortDirection;\n      }\n    }\n\n    sortValue = sortObject;\n  }\n\n  if (cmd.sort) findCmd.sort = sortValue;\n  if (cmd.fields) findCmd.projection = cmd.fields;\n  if (cmd.hint) findCmd.hint = cmd.hint;\n  if (cmd.skip) findCmd.skip = cmd.skip;\n  if (cmd.limit) findCmd.limit = cmd.limit;\n  if (cmd.limit < 0) {\n    findCmd.limit = Math.abs(cmd.limit);\n    findCmd.singleBatch = true;\n  }\n\n  if (typeof cmd.batchSize === 'number') {\n    if (cmd.batchSize < 0) {\n      if (cmd.limit !== 0 && Math.abs(cmd.batchSize) < Math.abs(cmd.limit)) {\n        findCmd.limit = Math.abs(cmd.batchSize);\n      }\n\n      findCmd.singleBatch = true;\n    }\n\n    findCmd.batchSize = Math.abs(cmd.batchSize);\n  }\n\n  if (cmd.comment) findCmd.comment = cmd.comment;\n  if (cmd.maxScan) findCmd.maxScan = cmd.maxScan;\n  if (cmd.maxTimeMS) findCmd.maxTimeMS = cmd.maxTimeMS;\n  if (cmd.min) findCmd.min = cmd.min;\n  if (cmd.max) findCmd.max = cmd.max;\n  findCmd.returnKey = cmd.returnKey ? cmd.returnKey : false;\n  findCmd.showRecordId = cmd.showDiskLoc ? cmd.showDiskLoc : false;\n  if (cmd.snapshot) findCmd.snapshot = cmd.snapshot;\n  if (cmd.tailable) findCmd.tailable = cmd.tailable;\n  if (cmd.oplogReplay) findCmd.oplogReplay = cmd.oplogReplay;\n  if (cmd.noCursorTimeout) findCmd.noCursorTimeout = cmd.noCursorTimeout;\n  if (cmd.awaitData) findCmd.awaitData = cmd.awaitData;\n  if (cmd.awaitdata) findCmd.awaitData = cmd.awaitdata;\n  if (cmd.partial) findCmd.partial = cmd.partial;\n  if (cmd.collation) findCmd.collation = cmd.collation;\n  if (cmd.readConcern) findCmd.readConcern = cmd.readConcern;\n\n  // If we have explain, we need to rewrite the find command\n  // to wrap it in the explain command\n  if (cmd.explain) {\n    findCmd = {\n      explain: findCmd\n    };\n  }\n\n  return findCmd;\n}\n\nfunction prepareLegacyFindQuery(server, ns, cmd, cursorState, options) {\n  options = options || {};\n  const bson = server.s.bson;\n  const readPreference = getReadPreference(cmd, options);\n  cursorState.batchSize = cmd.batchSize || cursorState.batchSize;\n\n  let numberToReturn = 0;\n  if (\n    cursorState.limit < 0 ||\n    (cursorState.limit !== 0 && cursorState.limit < cursorState.batchSize) ||\n    (cursorState.limit > 0 && cursorState.batchSize === 0)\n  ) {\n    numberToReturn = cursorState.limit;\n  } else {\n    numberToReturn = cursorState.batchSize;\n  }\n\n  const numberToSkip = cursorState.skip || 0;\n\n  const findCmd = {};\n  if (isSharded(server) && readPreference) {\n    findCmd['$readPreference'] = readPreference.toJSON();\n  }\n\n  if (cmd.sort) findCmd['$orderby'] = cmd.sort;\n  if (cmd.hint) findCmd['$hint'] = cmd.hint;\n  if (cmd.snapshot) findCmd['$snapshot'] = cmd.snapshot;\n  if (typeof cmd.returnKey !== 'undefined') findCmd['$returnKey'] = cmd.returnKey;\n  if (cmd.maxScan) findCmd['$maxScan'] = cmd.maxScan;\n  if (cmd.min) findCmd['$min'] = cmd.min;\n  if (cmd.max) findCmd['$max'] = cmd.max;\n  if (typeof cmd.showDiskLoc !== 'undefined') findCmd['$showDiskLoc'] = cmd.showDiskLoc;\n  if (cmd.comment) findCmd['$comment'] = cmd.comment;\n  if (cmd.maxTimeMS) findCmd['$maxTimeMS'] = cmd.maxTimeMS;\n  if (cmd.explain) {\n    // nToReturn must be 0 (match all) or negative (match N and close cursor)\n    // nToReturn > 0 will give explain results equivalent to limit(0)\n    numberToReturn = -Math.abs(cmd.limit || 0);\n    findCmd['$explain'] = true;\n  }\n\n  findCmd['$query'] = cmd.query;\n  if (cmd.readConcern && cmd.readConcern.level !== 'local') {\n    throw new MongoError(\n      `server find command does not support a readConcern level of ${cmd.readConcern.level}`\n    );\n  }\n\n  if (cmd.readConcern) {\n    cmd = Object.assign({}, cmd);\n    delete cmd['readConcern'];\n  }\n\n  const serializeFunctions =\n    typeof options.serializeFunctions === 'boolean' ? options.serializeFunctions : false;\n  const ignoreUndefined =\n    typeof options.ignoreUndefined === 'boolean' ? options.ignoreUndefined : false;\n\n  const query = new Query(bson, ns, findCmd, {\n    numberToSkip: numberToSkip,\n    numberToReturn: numberToReturn,\n    pre32Limit: typeof cmd.limit !== 'undefined' ? cmd.limit : undefined,\n    checkKeys: false,\n    returnFieldSelector: cmd.fields,\n    serializeFunctions: serializeFunctions,\n    ignoreUndefined: ignoreUndefined\n  });\n\n  if (typeof cmd.tailable === 'boolean') query.tailable = cmd.tailable;\n  if (typeof cmd.oplogReplay === 'boolean') query.oplogReplay = cmd.oplogReplay;\n  if (typeof cmd.noCursorTimeout === 'boolean') query.noCursorTimeout = cmd.noCursorTimeout;\n  if (typeof cmd.awaitData === 'boolean') query.awaitData = cmd.awaitData;\n  if (typeof cmd.partial === 'boolean') query.partial = cmd.partial;\n\n  query.slaveOk = readPreference.slaveOk();\n  return query;\n}\n\nmodule.exports = query;\n"]},"metadata":{},"sourceType":"script"}