{"ast":null,"code":"'use strict';\n\nconst AuthProvider = require('./auth_provider').AuthProvider;\n\nconst retrieveKerberos = require('../utils').retrieveKerberos;\n\nlet kerberos;\n/**\n * Creates a new SSPI authentication mechanism\n * @class\n * @extends AuthProvider\n */\n\nclass SSPI extends AuthProvider {\n  /**\n   * Implementation of authentication for a single connection\n   * @override\n   */\n  _authenticateSingleConnection(sendAuthCommand, connection, credentials, callback) {\n    // TODO: Destructure this\n    const username = credentials.username;\n    const password = credentials.password;\n    const mechanismProperties = credentials.mechanismProperties;\n    const gssapiServiceName = mechanismProperties['gssapiservicename'] || mechanismProperties['gssapiServiceName'] || 'mongodb';\n    SSIPAuthenticate(this, kerberos.processes.MongoAuthProcess, username, password, gssapiServiceName, sendAuthCommand, connection, mechanismProperties, callback);\n  }\n  /**\n   * Authenticate\n   * @override\n   * @method\n   */\n\n\n  auth(sendAuthCommand, connections, credentials, callback) {\n    if (kerberos == null) {\n      try {\n        kerberos = retrieveKerberos();\n      } catch (e) {\n        return callback(e, null);\n      }\n    }\n\n    super.auth(sendAuthCommand, connections, credentials, callback);\n  }\n\n}\n\nfunction SSIPAuthenticate(self, MongoAuthProcess, username, password, gssapiServiceName, sendAuthCommand, connection, options, callback) {\n  const authProcess = new MongoAuthProcess(connection.host, connection.port, gssapiServiceName, options);\n\n  function authCommand(command, authCb) {\n    sendAuthCommand(connection, '$external.$cmd', command, authCb);\n  }\n\n  authProcess.init(username, password, err => {\n    if (err) return callback(err, false);\n    authProcess.transition('', (err, payload) => {\n      if (err) return callback(err, false);\n      const command = {\n        saslStart: 1,\n        mechanism: 'GSSAPI',\n        payload,\n        autoAuthorize: 1\n      };\n      authCommand(command, (err, doc) => {\n        if (err) return callback(err, false);\n        authProcess.transition(doc.payload, (err, payload) => {\n          if (err) return callback(err, false);\n          const command = {\n            saslContinue: 1,\n            conversationId: doc.conversationId,\n            payload\n          };\n          authCommand(command, (err, doc) => {\n            if (err) return callback(err, false);\n            authProcess.transition(doc.payload, (err, payload) => {\n              if (err) return callback(err, false);\n              const command = {\n                saslContinue: 1,\n                conversationId: doc.conversationId,\n                payload\n              };\n              authCommand(command, (err, response) => {\n                if (err) return callback(err, false);\n                authProcess.transition(null, err => {\n                  if (err) return callback(err, null);\n                  callback(null, response);\n                });\n              });\n            });\n          });\n        });\n      });\n    });\n  });\n}\n\nmodule.exports = SSPI;","map":{"version":3,"sources":["/home/hoangnd/source/ReactJS/todolist/node_modules/mongodb/lib/core/auth/sspi.js"],"names":["AuthProvider","require","retrieveKerberos","kerberos","SSPI","_authenticateSingleConnection","sendAuthCommand","connection","credentials","callback","username","password","mechanismProperties","gssapiServiceName","SSIPAuthenticate","processes","MongoAuthProcess","auth","connections","e","self","options","authProcess","host","port","authCommand","command","authCb","init","err","transition","payload","saslStart","mechanism","autoAuthorize","doc","saslContinue","conversationId","response","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nconst AuthProvider = require('./auth_provider').AuthProvider;\nconst retrieveKerberos = require('../utils').retrieveKerberos;\nlet kerberos;\n\n/**\n * Creates a new SSPI authentication mechanism\n * @class\n * @extends AuthProvider\n */\nclass SSPI extends AuthProvider {\n  /**\n   * Implementation of authentication for a single connection\n   * @override\n   */\n  _authenticateSingleConnection(sendAuthCommand, connection, credentials, callback) {\n    // TODO: Destructure this\n    const username = credentials.username;\n    const password = credentials.password;\n    const mechanismProperties = credentials.mechanismProperties;\n    const gssapiServiceName =\n      mechanismProperties['gssapiservicename'] ||\n      mechanismProperties['gssapiServiceName'] ||\n      'mongodb';\n\n    SSIPAuthenticate(\n      this,\n      kerberos.processes.MongoAuthProcess,\n      username,\n      password,\n      gssapiServiceName,\n      sendAuthCommand,\n      connection,\n      mechanismProperties,\n      callback\n    );\n  }\n\n  /**\n   * Authenticate\n   * @override\n   * @method\n   */\n  auth(sendAuthCommand, connections, credentials, callback) {\n    if (kerberos == null) {\n      try {\n        kerberos = retrieveKerberos();\n      } catch (e) {\n        return callback(e, null);\n      }\n    }\n\n    super.auth(sendAuthCommand, connections, credentials, callback);\n  }\n}\n\nfunction SSIPAuthenticate(\n  self,\n  MongoAuthProcess,\n  username,\n  password,\n  gssapiServiceName,\n  sendAuthCommand,\n  connection,\n  options,\n  callback\n) {\n  const authProcess = new MongoAuthProcess(\n    connection.host,\n    connection.port,\n    gssapiServiceName,\n    options\n  );\n\n  function authCommand(command, authCb) {\n    sendAuthCommand(connection, '$external.$cmd', command, authCb);\n  }\n\n  authProcess.init(username, password, err => {\n    if (err) return callback(err, false);\n\n    authProcess.transition('', (err, payload) => {\n      if (err) return callback(err, false);\n\n      const command = {\n        saslStart: 1,\n        mechanism: 'GSSAPI',\n        payload,\n        autoAuthorize: 1\n      };\n\n      authCommand(command, (err, doc) => {\n        if (err) return callback(err, false);\n\n        authProcess.transition(doc.payload, (err, payload) => {\n          if (err) return callback(err, false);\n          const command = {\n            saslContinue: 1,\n            conversationId: doc.conversationId,\n            payload\n          };\n\n          authCommand(command, (err, doc) => {\n            if (err) return callback(err, false);\n\n            authProcess.transition(doc.payload, (err, payload) => {\n              if (err) return callback(err, false);\n              const command = {\n                saslContinue: 1,\n                conversationId: doc.conversationId,\n                payload\n              };\n\n              authCommand(command, (err, response) => {\n                if (err) return callback(err, false);\n\n                authProcess.transition(null, err => {\n                  if (err) return callback(err, null);\n                  callback(null, response);\n                });\n              });\n            });\n          });\n        });\n      });\n    });\n  });\n}\n\nmodule.exports = SSPI;\n"]},"metadata":{},"sourceType":"script"}